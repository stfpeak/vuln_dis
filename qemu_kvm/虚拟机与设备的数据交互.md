### 虚拟机接收数据包来说明虚拟机和设备的交互
1. 当数据包到达主机的物理网卡后，调用物理网卡的驱动程序，在其中利用Linux内核中的软件网桥，实现数据的转发。
2. 在软件网挢这一层，会判断数据包是发往那个设备的，同时调用网桥的发送函数，向对应的端口发送数据包。
3. 若数据包是发往虚拟机的，则要通过tap设备进行转发，tap设备由两部分组成，网络设备和字符设备。网络设备负责接收和发送数据包，字符设备负责将数据包往内核空间和用户空间进行转发。Tap网络部分收到数据包后，将其设备文件符置位，同时向正在运行VM的进程发出I/O可用信号，引起VM Exit，停止VM运行，进入根操作状态。KVM根据KVM_EXIT_REASON判断原因，模拟I/O指令的执行，将中断注入到VM的中断向量表中。
4. 返回用户模式的Qemu中，执行设备模型。返回到kvm_main loop中，执行Kvm—main—loop—wait，之后进入main_loop wait中，在这个函数里收集对应设备的设备文件描述符的状态，此时tap设备文件描述符的状态同样被集到fd set。
5. Kvm main—loop不停地循环，通过select系统调用判断哪螋文件描述符的状态发生变化，相应的调用对应的处理函数。对予tap来说，就会通过Qemu—send_packet将数据发往rtl8139一do—receiver，在这个函数中完成相当于硬件RTL8139网卡的逻辑操作。KVM通过模拟I／O指令操作虚拟RTL8139将数据拷贝到用户地址空间，放在相应的I／O地址。用户模式处理完毕后返回内核模式，而后进入客户模式，VM被再次执行，继续收发数据包。
